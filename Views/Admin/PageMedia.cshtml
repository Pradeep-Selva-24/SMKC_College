@{
    ViewData["Title"] = "Page Media";
    Layout = "_AdminLayout";
}

<div class="page-container">

    <div class="form-card">

        <div class="page-header-card">
            <h4 class="page-title">Page Media</h4>
            <button type="button"
                    class="btn btn-primary view-btn"
                    onclick="window.location.href='/Admin/PageMedia/List'">
                View
            </button>
        </div>

        <div id="msg"></div>

        <div class="row g-4">

            <div class="col-lg-6">
                <label class="form-label">Category</label>
                <select class="form-select" id="category">
                    <option value="">-- Select Category --</option>
                    <option value="HOME_BANNER">Home Banner (1920x1080)</option>
                    <option value="EVENT_BANNER">Event Banner (1200x600)</option>
                    <option value="NOTICE_BANNER">Notice Banner (800x800)</option>
                    <option value="GALLERY_BANNER">Gallery Banner (1024x768)</option>
                </select>
            </div>

            <div class="col-lg-6">
                <label class="form-label">Banner Image</label>
                <input type="file" class="form-control" id="imageInput" accept="image/*">
            </div>

            <div class="col-12 text-center">
                <img id="preview" style="display:none;">
            </div>

            <div class="col-lg-6">
                <label>Heading</label>
                <input type="text" id="heading" class="form-control">
            </div>

            <div class="col-lg-6">
                <label>Display Order</label>
                <input type="number" id="displayOrder" class="form-control" value="1">
            </div>

            <div class="col-12">
                <label>Short Content</label>
                <textarea id="shortContent" class="form-control" rows="4"></textarea>
            </div>

        </div>

        <div class="action-buttons">
            <button type="button" class="btn-cancel" onclick="resetForm()">Cancel</button>
            <button class="btn-submit" onclick="saveBanner()">Save Banner</button>
        </div>

    </div>

</div>

<script>
    let cropper;
    const input = document.getElementById('imageInput');
    const preview = document.getElementById('preview');

    const categorySettings = {
        "HOME_BANNER": { width: 1920, height: 1080, aspectRatio: 16 / 9 },
        "EVENT_BANNER": { width: 1200, height: 600, aspectRatio: 2 / 1 },
        "NOTICE_BANNER": { width: 800, height: 800, aspectRatio: 1 / 1 },
        "GALLERY_BANNER": { width: 1024, height: 768, aspectRatio: 4 / 3 }
    };

    function getSelectedSetting() {
        const category = document.getElementById("category").value;
        return categorySettings[category];
    }

    input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const setting = getSelectedSetting();

        if (!setting) {
            alert("Please select Category first!");
            input.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = () => {
            preview.src = reader.result;
            preview.style.display = 'block';

            if (cropper) cropper.destroy();

            cropper = new Cropper(preview, {
                aspectRatio: setting.aspectRatio,
                viewMode: 1
            });
        };
        reader.readAsDataURL(file);
    });

    function resetForm() {
        document.getElementById("category").value = "";
        document.getElementById("heading").value = "";
        document.getElementById("shortContent").value = "";
        document.getElementById("displayOrder").value = 1;
        document.getElementById("imageInput").value = "";

        if (cropper) {
            cropper.destroy();
            cropper = null;
        }

        preview.src = "";
        preview.style.display = "none";
    }

    function saveBanner() {
        const category = document.getElementById("category").value;

        if (!category) {
            alert("Please select Category");
            return;
        }

        if (!cropper) {
            alert("Please select and crop an image");
            return;
        }

        const setting = getSelectedSetting();

        cropper.getCroppedCanvas({
            width: setting.width,
            height: setting.height
        }).toBlob(blob => {

            const formData = new FormData();
            formData.append("bannerImage", blob, "banner.jpg");
            formData.append("category", category);
            formData.append("heading", document.getElementById("heading").value);
            formData.append("shortContent", document.getElementById("shortContent").value);
            formData.append("displayOrder", document.getElementById("displayOrder").value);

            fetch("/Admin/SavePageMedia", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById("msg").innerHTML =
                    `<div class="alert alert-success">${data.message}</div>`;

                resetForm();
            })
            .catch(() => {
                document.getElementById("msg").innerHTML =
                    `<div class="alert alert-danger">Upload failed</div>`;
            });

        }, "image/jpeg", 0.9);
    }
</script>
