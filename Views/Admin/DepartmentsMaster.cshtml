@{
    ViewData["Title"] = "Departments Master";
    Layout = "_AdminLayout";
}

<div class="page-container clsPageMedia">

    <div class="form-card">

        <div class="page-header-card">
            <h4 class="page-title">Departments Master</h4>
            <button type="button" class="btn btn-primary view-btn clsView" onclick="Add()">Add</button>
            <button type="button" class="btn btn-primary view-btn clsAdd clsEdit" onclick="View()">View</button>
        </div>

        <div class="clsView">
            <div class="row g-3 mt-20" id="ViewPageMedia">
            </div>
        </div>

        <div class="clsAdd clsEdit">
            <div id="msg"></div>

            <div class="row g-4">
                <input type="hidden" id="Key" value="" />
                <div class="col-lg-6">
                    <label>Department</label>
                    <input type="text" id="Department" class="form-control">
                </div>

                <div class="col-lg-6">
                    <label>Display Order</label>
                    <input type="number" id="Order" class="form-control" value="1">
                </div>

                <div class="col-lg-6">
                    <label>Description</label>
                    <textarea id="Description" class="form-control" rows="2"></textarea>
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Image</label>
                    <input type="file" class="form-control" id="imageInput" accept="image/*">
                </div>

                <div class="col-lg-12 text-center">
                    <img id="preview" style="display:none;">
                </div>

            </div>

            <div class="action-buttons">
                <button class="btn-cancel clsAdd" onclick="resetForm()">Cancel</button>
                <button class="btn-submit clsAdd" onclick="Save()">Save</button>
                <button class="btn-submit clsEdit" onclick="Save()">Update</button>
            </div>
        </div>

    </div>
</div>

<script>

    var cropper = null;
    var imageChanged = false;

    $(document).ready(function () {
        View()
    });

    function View(){
        resetForm()
        $(".clsView").show();
        $(".clsAdd, .clsEdit").hide();
        DataLoad();
    }

    function Add(){
        resetForm()
        $(".clsView, .clsEdit").hide();
        $(".clsAdd").show();
    }

    function resetForm() {
        $('#Key').val('');
        $('#Department').val('');
        $('#Order').val(1);
        $('#imageInput').val('');
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        imageChanged = false;

        $('#Description').val('');
        $('#preview').attr('src', '').hide();
    }

    function DataLoad(){
        LoaderShow();
        $("#ViewPageMedia").html('');
        $.ajax({
            url: '/Admin/GetDepartmentsMaster',
            type: 'GET',
            data: '',
            success: function(response) {
                if(response.message === "Success") {
                    var data = JSON.parse(response.result);

                    var Content = Buind(data);

                    if(Content.length > 0){
                        $("#ViewPageMedia").html(Content);
                    }

                } else {
                    alert('Failed to load data.');
                }
                LoaderHide();
            },
            error: function(err) {
                console.error(err);
                alert('Error while loading data.');
                LoaderHide();
            }
        });
    }

    function Buind(data){
        var str = "";
        let randomNum = (Math.random() * 5).toFixed(2);
        $.each(data, function (i, y) {
            str += '<div class="col-lg-4 col-md-6">';
            str += '<div class="PageMedia-card">';

            str += '<div class="PageMedia-img">';
            str += '<img src="' +y["ImagePath"]+ '?V' + randomNum + '" alt="Image">';
            str += '</div>';

            str += '<div class="PageMedia-body">';
            str += '<div class="PageMedia-title">' +y["Department"]+ '</div>';

            str += '<div class="PageMedia-actions">';

            if(y["Status"]){
                str += '<a href="javascript:void(0);" onclick="Edit(' +y["Id"]+ ')" class="text-primary" title="Edit">';
                str += '<i class="bi bi-pencil-square"></i>';
                str += '</a>';

                str += '<a href="javascript:void(0);" onclick="StatusUpdate(' +y["Id"]+ ', false)" class="text-danger" title="Delete">';
                str += '<i class="bi bi-trash"></i>';
                str += '</a>';
            }
            else{
                str += '<a href="javascript:void(0);" onclick="StatusUpdate(' +y["Id"]+ ', true)" class="text-success" title="Activate">';
                str += '<i class="bi bi-check-circle fs-5"></i>';
                str += '</a>';
            }

            str += '</div>';
            str += '</div>';
            str += '</div>';
            str += '</div>';
        })

        return str;
    }

    function StatusUpdate(Id, status) {
        LoaderShow();
        $.ajax({
            url: '/Admin/StatusUpdateDepartmentsMaster',
            type: 'POST',
            data: { Id: Id, IsStatus: status },
            success: function(response){
                alert(response.message);
                LoaderHide();
            },
            error: function(err){
                console.error(err);
                alert('Error while saving data.');
                LoaderHide();
            }
        });
    }

    function Edit(Id){
        resetForm()
        $(".clsView, .clsAdd").hide();
        $(".clsEdit").show();
        $('#Key').val(Id)
        LoaderShow();
        $.ajax({
            url: '/Admin/GetDepartmentsMasterById',
            type: 'GET',
            data: { Id: Id },
            success: function(response) {
                if(response.message === "Success") {
                    var data = JSON.parse(response.result);

                    $('#Department').val(data.Department);
                    $('#Order').val(data.Order);
                    $('#Description').val(data.Description);

                    loadImageForEdit(data.ImagePath)
                }
                else {
                    alert('Failed to load data.');
                }
                LoaderHide();
            },
            error: function(err) {
                console.error(err);
                alert('Error while loading data.');
                LoaderHide();
            }
        });
    }

    // Image change
    $('#imageInput').on('change', function (e) {

        var file = e.target.files[0];
        if (!file) return;

        LoaderShow();
        cropperReady = false;

        var reader = new FileReader();
        reader.onload = function () {

            var img = document.getElementById('preview');
            img.onload = function () {

                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(img, {
                    aspectRatio: 16/9,
                    viewMode: 1,
                    ready() {
                        cropperReady = true;
                        LoaderHide();
                    }
                });
            };

            $('#preview').attr('src', reader.result).show();
        };

        reader.readAsDataURL(file);
    });

    function loadImageForEdit(imageUrl) {
        if (!imageUrl) return;

        LoaderShow();
        cropperReady = false;

        var img = document.getElementById('preview');

        img.onload = function () {
            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(img, {
                aspectRatio: 16/9,
                viewMode: 1,
                ready() {
                    cropperReady = true;
                    LoaderHide();
                }
            });
        };

        $('#preview')
            .attr('src', imageUrl + '?t=' + new Date().getTime())
            .show();
    }

    function Save() {

        var id = $('#Key').val() || 0;

        if (!cropper && id == 0) {
            alert("Please select and crop an image");
            return;
        }

        if (cropper && !cropperReady) {
            alert("Image is still loading. Please wait and try again.");
            return;
        }

        var formData = new FormData();
        formData.append("Id", id);
        formData.append("Department", $('#Department').val());
        formData.append("Description", $('#Description').val());
        formData.append("Order", $('#Order').val());

        LoaderShow();

        if (cropper) {
            cropper.getCroppedCanvas({
                width: 1920,
                height: 1080
            }).toBlob(function (blob) {

                if (!blob) {
                    alert("Image processing failed. Try again.");
                    LoaderHide();
                    return;
                }

                formData.append("bannerImage", blob, "banner.jpg");
                sendRequest(formData);

            }, "image/jpeg", 0.9);
        }
        else {
            sendRequest(formData);
        }
    }

    function sendRequest(formData) {
        $.ajax({
            url: "/Admin/SaveDepartmentsMaster",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                alert(data.message);

                if (data.message && data.message.toLowerCase().includes("success")) {
                    View();
                }

                LoaderHide();
            },
            error: function (xhr, status, error) {
                console.error(error);
                alert('Error while saving data.');
                LoaderHide();
            }
        });
    }

</script>

